From 65f76ed6a8bff99e0803243b168572b1f3827a64 Mon Sep 17 00:00:00 2001
From: "Paul A. Patience" <paul@apatience.com>
Date: Fri, 12 Jan 2024 05:16:50 -0500
Subject: [PATCH] Build on Chimera Linux

---
 src/koga/config-header.lisp | 1 +
 src/koga/units.lisp         | 6 +++---
 2 files changed, 4 insertions(+), 3 deletions(-)

diff --git a/src/koga/config-header.lisp b/src/koga/config-header.lisp
index bf8ca7496b..5734e4ce85 100644
--- a/src/koga/config-header.lisp
+++ b/src/koga/config-header.lisp
@@ -33,6 +33,7 @@
                  "USE_MMTK" (eq :mmtk *variant-gc*)
                  "USE_MPS" (eq :mps *variant-gc*)
                  "USE_MPI" (mpi configuration)
+                 "USE_LIBUNWIND" t
                  "RUNNING_PRECISEPREP" *variant-prep*
                  "PROGRAM_CLASP" t
                  "CLASP_THREADS" t
diff --git a/src/koga/units.lisp b/src/koga/units.lisp
index 012ea4f2ae..36c2ddfb2b 100644
--- a/src/koga/units.lisp
+++ b/src/koga/units.lisp
@@ -143,7 +143,7 @@
     (message :emph "Configuring git")
     (setf git (configure-program "git"
                                  (or git #P"git")
-                                 :required t))))
+                                 :required nil))))
 
 (defmethod configure-unit (configuration (unit (eql :objcopy)))
   "Find the objcopy binary."
@@ -208,11 +208,11 @@
                                :type :cxxflags)
   #+darwin (append-cflags configuration "-stdlib=libc++" :type :cxxflags)
   #+darwin (append-cflags configuration "-I/usr/local/include")
-  #+linux (append-cflags configuration "-fno-omit-frame-pointer -mno-omit-leaf-frame-pointer -fno-stack-protector -stdlib=libstdc++"
+  #+linux (append-cflags configuration "-fno-omit-frame-pointer -mno-omit-leaf-frame-pointer -fno-stack-protector"
                                        :type :cxxflags)
   #+linux (append-cflags configuration "-fno-omit-frame-pointer -mno-omit-leaf-frame-pointer -fno-stack-protector"
                                        :type :cflags)
-  #+linux (append-ldlibs configuration "-ldl")
+  #+linux (append-ldlibs configuration "-ldl -lucontext")
   (when (address-sanitizer configuration)
     (append-cflags configuration "-fsanitize=address" :type :cxxflags)
     (append-ldflags configuration "-fsanitize=address"))
-- 
2.41.0

